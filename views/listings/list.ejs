<% layout("/layouts/boilerplate.ejs") %>

  <body>

    <div class="singlecon offset-auto">
      <h2>
        <%= onelist.title %>
      </h2>

      <div class="detail-card">

        <div class="image-box">
          <% if (onelist.image && onelist.image.length> 0) { %>
            <div id="carouselExampleAutoplaying" class="carousel slide" data-bs-ride="carousel">

              <!-- Indicators -->
              <div class="carousel-indicators">
                <% onelist.image.forEach((img, index)=> { %>
                  <button type="button" data-bs-target="#carouselExampleAutoplaying" data-bs-slide-to="<%= index %>"
                    class="<%= index === 0 ? 'active' : '' %>" aria-current="<%= index === 0 ? 'true' : 'false' %>"
                    aria-label="Slide <%= index + 1 %>"></button>
                  <% }); %>
              </div>

              <!-- Images -->
              <div class="carousel-inner">
                <% onelist.image.forEach((img, index)=> { %>
                  <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                    <img src="<%= img.url %>" class="d-block w-100" alt="<%= img.filename || 'Image' %>">
                  </div>
                  <% }); %>
              </div>

              <!-- Controls -->
              <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleAutoplaying" data-bs-slide="prev">

                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleAutoplaying"
                data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
              </button>
            </div>
            <% } else { %>
              <p>No image available</p>
              <% } %>

        </div>

        <div class="info">

          <h3>
            <%= onelist.location %>, <%= onelist.country %>
          </h3>
          <p class="description">
            <%= onelist.description %>
          </p>
          <h5>
            owner: <%= onelist.owner.username %>
          </h5>
          <div class="details">
            <p><strong>Price:</strong> ₹<%= onelist.price %>
            </p>
            <p><strong>ID:</strong>
              <%= onelist._id %>
            </p>
          </div>

          <% if (currUser && currUser._id.equals(onelist.owner._id)) { %>
            <div class="buttons">
              <form method="get" action="/listings/<%= onelist._id %>/update">
                <button class="btn btn-dark">Edit</button>
              </form>
              <form method="post" action="/listings/<%= onelist._id %>?_method=delete">
                <button class="btn btn-outline-danger">Delete</button>
              </form>
            </div>
            <% } %>


        </div>
      </div>

      <br>
      <div id="map" style="height: 500px;"></div>
    </div>
    </div>

    <div class="singlecon offset-3">
      <hr>
      <% if (currUser) { %>
        <h4>Leave a review</h4>
        <form method="post" action="/listings/<%= onelist._id %>/reviews" class="needs-validation" novalidate>
          <div class="mb-3">
            <label for="rating" class="form-label">Rating</label>
            <div class="star-rating">
              <input type="radio" name="review[rating]" value="5" id="5"><label for="5">★</label>
              <input type="radio" name="review[rating]" value="4" id="4"><label for="4">★</label>
              <input type="radio" name="review[rating]" value="3" id="3"><label for="3">★</label>
              <input type="radio" name="review[rating]" value="2" id="2"><label for="2">★</label>
              <input type="radio" name="review[rating]" value="1" id="1"><label for="1">★</label>
            </div>
          </div>
          <div class="mb-3">
            <label for="exampleFormControlTextarea1" class="form-label">Comments</label>
            <textarea class="form-control" name="review[comment]" id="comment" rows="3" placeholder="Write a comment"
              required></textarea>
            <div class="invalid-feedback">
              comment required!
            </div>
          </div>

          <button class="btn btn-outline-dark">Submit</button>
        </form>
        <hr>
        <% } %>


          <h3>All reviews</h3>
          <div class="row">
            <% for( let review of onelist.review ) { %>

              <div class="col-sm-6 mb-3 mb-sm-3">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">
                      <%= review.author.username %>
                    </h5>
                    <span class="stars">
                      <% for (let i=1; i <=5; i++) { %>
                        <% if (i <=review.rating) { %>
                          ★
                          <% } else { %>
                            ☆
                            <% } %>
                              <% } %>
                    </span>
                    </p>


                    <p class="card-text">
                      <%= review.comment %>

                    </p>


                    <form method="post" action="/listings/<%= onelist._id %>/reviews/<%= review._id %>?_method=delete">
                      <button class="btn btn-sm btn-dark">delete</button>
                    </form>
                  </div>
                </div>

              </div>


              <% } %>
          </div>
    </div>
    <!-- 🌍 Map Script -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const locationName = "<%= onelist.location %>";
        const listingTitle = "<%= onelist.title %>";

        const map = L.map('map', { scrollWheelZoom: false }).setView([20.5937, 78.9629], 5);

        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
          maxZoom: 20,
          attribution: '© OpenStreetMap, Tiles © HOT'
        }).addTo(map);

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          maxZoom: 20,
          attribution: '© Esri & Contributors'
        });

        const darkLayer = L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/dark_all/{z}/{x}/{y}{r}.png', {
          maxZoom: 19,
          attribution: '© OSM & CARTO'
        });

        L.control.layers({
          "Street": streetLayer,
          "Satellite": satelliteLayer,
          "Dark": darkLayer
        }).addTo(map);

        const redIcon = new L.Icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });

        map.on('click', () => map.scrollWheelZoom.enable());

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName)}`, {
          headers: {
            'User-Agent': 'SemesterApp/1.0 (manav@example.com)'
          }
        })
          .then(res => res.json())
          .then(data => {
            if (data.length > 0) {
              const lat = data[0].lat;
              const lon = data[0].lon;
              map.setView([lat, lon], 13);

              L.marker([lat, lon], { icon: redIcon }).addTo(map)
                .bindPopup(`<b>${listingTitle}</b><br>${locationName}`)
                .openPopup();
            } else {
              console.warn("Location not found:", locationName);
            }
          })
          .catch(err => console.error("Map error:", err));
      });
    </script>


  </body>